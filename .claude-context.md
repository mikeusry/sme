# Soul Miners - Project Documentation

## Project Overview

Soul Miners is a modern e-commerce platform built with:
- **Frontend**: Astro + Tailwind CSS
- **Backend**: Medusa (Node.js e-commerce framework)
- **Database**: PostgreSQL
- **Cache/Events**: Redis
- **Payments**: Stripe
- **Fulfillment**: Custom local delivery + Manual fulfillment
- **Deployment**: Vercel (frontend) + Railway (backend)
- **Containerization**: Docker

## Project Structure

```
Soul-Miners-Eden/
├── frontend/                 # Astro frontend application
│   ├── src/
│   │   ├── components/      # Reusable UI components
│   │   │   ├── Header.astro
│   │   │   └── Footer.astro
│   │   ├── layouts/         # Page layouts
│   │   │   ├── BaseLayout.astro
│   │   │   └── MainLayout.astro
│   │   ├── pages/           # Astro pages (file-based routing)
│   │   │   ├── index.astro  # Homepage
│   │   │   ├── products/    # Products pages
│   │   │   ├── cart.astro
│   │   │   └── checkout.astro
│   │   ├── lib/             # Utility functions
│   │   │   └── medusa.ts    # Medusa API client & helpers
│   │   └── styles/
│   │       └── global.css   # Global styles with Tailwind
│   ├── tailwind.config.js   # Tailwind configuration
│   ├── astro.config.mjs     # Astro configuration
│   ├── .env.example         # Environment variables template
│   └── package.json
│
├── backend/                 # Medusa backend application
│   ├── src/
│   │   ├── api/            # Custom API endpoints
│   │   ├── services/       # Business logic services
│   │   │   └── local-delivery-fulfillment.ts
│   │   ├── models/         # Database models
│   │   ├── repositories/   # Data access layer
│   │   └── subscribers/    # Event subscribers
│   ├── data/               # Seed data
│   ├── medusa-config.ts    # Medusa configuration
│   ├── tsconfig.json       # TypeScript configuration
│   ├── Dockerfile          # Docker image definition
│   ├── .dockerignore       # Docker ignore file
│   ├── railway.json        # Railway deployment config
│   ├── .env.example        # Environment variables template
│   ├── RAILWAY_DEPLOYMENT.md # Railway deployment guide
│   └── package.json
│
├── docker-compose.yml      # Local development environment
├── package.json            # Monorepo root package.json
├── .gitignore             # Git ignore file
└── README.md              # This file

## Tech Stack Details

### Frontend (Astro + Tailwind CSS)

**Why Astro?**
- Zero JavaScript by default (faster load times)
- Partial hydration for interactive components
- File-based routing
- Excellent SEO
- TypeScript support

**Tailwind CSS Configuration:**
- Custom color palette (primary, secondary)
- Custom fonts (Inter, Poppins)
- Utility components (buttons, cards, inputs)
- Responsive design utilities
- Plugins: @tailwindcss/forms, @tailwindcss/typography

**Key Features:**
- Server-side rendering (SSR) for dynamic content
- Static site generation (SSG) where possible
- Medusa JS SDK integration for API calls
- Cart management via localStorage + API

### Backend (Medusa)

**Why Medusa?**
- Open-source, headless commerce platform
- Built on Node.js
- Extensive API for products, carts, orders
- Plugin architecture
- Built-in admin dashboard
- TypeORM for database management

**Plugins Configured:**
1. **@medusajs/admin**: Admin dashboard
2. **medusa-payment-stripe**: Stripe payment integration
3. **medusa-payment-manual**: Manual payment processing
4. **medusa-fulfillment-manual**: Basic fulfillment
5. **Custom local delivery**: Custom fulfillment provider for local delivery

**Custom Local Delivery Provider:**
- Three delivery options:
  - Standard (3-5 business days) - $5.99
  - Express (1-2 business days) - $12.99
  - Same Day (before 2 PM) - $19.99
- Free delivery over $50
- Service area validation (customizable)
- Located at: `backend/src/services/local-delivery-fulfillment.ts`

### Database & Caching

**PostgreSQL:**
- Primary database for all Medusa data
- Tables managed by TypeORM migrations
- Connection via DATABASE_URL environment variable

**Redis:**
- Cache layer for improved performance
- Event bus for async operations
- Session storage

## Development Workflow

### Prerequisites

- Node.js >= 18.0.0
- npm >= 9.0.0
- Docker & Docker Compose
- PostgreSQL (if not using Docker)
- Redis (if not using Docker)

### Local Development Setup

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd Soul-Miners-Eden
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Set up environment variables**

   Frontend:
   ```bash
   cd frontend
   cp .env.example .env
   # Edit .env with your values
   ```

   Backend:
   ```bash
   cd ../backend
   cp .env.example .env
   # Edit .env with your values
   ```

4. **Start Docker services** (PostgreSQL + Redis + Medusa)
   ```bash
   docker-compose up -d
   ```

5. **Run database migrations**
   ```bash
   npm run migrate --workspace=backend
   ```

6. **Start development servers**
   ```bash
   npm run dev
   ```

   This starts:
   - Frontend: http://localhost:4321
   - Backend API: http://localhost:9000
   - Admin Dashboard: http://localhost:9000/app

### Without Docker

If you prefer to run services locally:

1. Start PostgreSQL (ensure it's running on port 5432)
2. Start Redis (ensure it's running on port 6379)
3. Update `.env` files with correct connection strings
4. Run migrations: `npm run migrate --workspace=backend`
5. Start dev servers: `npm run dev`

## API Integration

The frontend communicates with Medusa via the Medusa JS SDK.

**Client Initialization:**
Location: `frontend/src/lib/medusa.ts`

**Available Functions:**
- `getProducts()` - List all products
- `getProduct(id)` - Get single product
- `getProductByHandle(handle)` - Get product by URL slug
- `getCollections()` - List collections
- `createCart()` - Create shopping cart
- `addToCart(cartId, variantId, quantity)` - Add item to cart
- `updateCartItem()` - Update cart item quantity
- `removeFromCart()` - Remove item from cart
- `completeCart()` - Create order from cart
- `searchProducts(query)` - Search products

**Example Usage:**
```typescript
import { getProducts, addToCart } from '../lib/medusa'

// Fetch products
const { products } = await getProducts({ limit: 20 })

// Add to cart
const cart = await addToCart(cartId, variantId, 1)
```

## Deployment

### Frontend Deployment (Vercel)

1. Connect your repository to Vercel
2. Set build settings:
   - Build Command: `npm run build --workspace=frontend`
   - Output Directory: `frontend/dist`
   - Install Command: `npm install`
3. Add environment variables:
   - `PUBLIC_MEDUSA_BACKEND_URL`: Your Railway backend URL
   - `PUBLIC_STRIPE_PUBLISHABLE_KEY`: Stripe public key
4. Deploy

### Backend Deployment (Railway)

See detailed guide: `backend/RAILWAY_DEPLOYMENT.md`

**Quick Steps:**
1. Install Railway CLI: `npm install -g @railway/cli`
2. Login: `railway login`
3. Create project: `railway init`
4. Add PostgreSQL database service
5. Add Redis service
6. Configure environment variables
7. Deploy: `railway up`

**Required Environment Variables:**
- `DATABASE_URL`: Provided by Railway PostgreSQL
- `REDIS_URL`: Provided by Railway Redis
- `JWT_SECRET`: Generate secure random string
- `COOKIE_SECRET`: Generate secure random string
- `STRIPE_API_KEY`: Your Stripe secret key
- `STRIPE_WEBHOOK_SECRET`: Stripe webhook secret
- `MEDUSA_BACKEND_URL`: Your Railway app URL
- `ADMIN_EMAIL`: Admin user email
- `ADMIN_PASSWORD`: Admin user password

## Docker Commands

**Start all services:**
```bash
docker-compose up -d
```

**Stop all services:**
```bash
docker-compose down
```

**View logs:**
```bash
docker-compose logs -f
```

**Rebuild backend:**
```bash
docker-compose up -d --build backend
```

**Access database:**
```bash
docker-compose exec postgres psql -U postgres -d soul_miners_medusa
```

## Admin Dashboard

Access the Medusa admin at: `http://localhost:9000/app`

**First-time Setup:**
1. Create admin user account
2. Set up regions and currencies
3. Add products and collections
4. Configure shipping options
5. Set up payment providers

**Managing Products:**
- Go to Products > Add Product
- Upload images
- Set variants (size, color, etc.)
- Configure pricing
- Add to collections

**Managing Orders:**
- View all orders in Orders section
- Process fulfillments
- Handle refunds and exchanges

## Environment Variables Reference

### Frontend (.env)

```env
PUBLIC_MEDUSA_BACKEND_URL=http://localhost:9000
PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
PUBLIC_SITE_NAME=Soul Miners
PUBLIC_SITE_URL=http://localhost:4321
```

### Backend (.env)

```env
# Database
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/soul_miners_medusa

# Redis
REDIS_URL=redis://localhost:6379

# Security
JWT_SECRET=supersecret
COOKIE_SECRET=supersecret

# Stripe
STRIPE_API_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# CORS
STORE_CORS=http://localhost:4321
ADMIN_CORS=http://localhost:9000
```

## Customization Guide

### Adding New Pages

1. Create file in `frontend/src/pages/`
2. Use MainLayout for consistent header/footer
3. Import Medusa utilities as needed

Example:
```astro
---
import MainLayout from '../layouts/MainLayout.astro'
import { getProducts } from '../lib/medusa'

const { products } = await getProducts()
---

<MainLayout title="My Page">
  <!-- Your content -->
</MainLayout>
```

### Creating Custom API Endpoints

1. Create file in `backend/src/api/`
2. Follow Medusa API conventions
3. Export GET, POST, etc. handlers

### Adding Custom Services

1. Create file in `backend/src/services/`
2. Extend Medusa base services
3. Inject via dependency injection

### Styling Components

Use Tailwind utility classes or add custom CSS in `global.css`

## Troubleshooting

### Frontend Issues

**Module not found errors:**
```bash
cd frontend && npm install
```

**Tailwind styles not applying:**
- Check `astro.config.mjs` has Tailwind plugin
- Verify `global.css` is imported in layouts

### Backend Issues

**Database connection failed:**
- Verify PostgreSQL is running
- Check DATABASE_URL in .env
- Ensure database exists

**Redis connection failed:**
- Verify Redis is running
- Check REDIS_URL in .env

**Admin dashboard not loading:**
- Run `npm run build --workspace=backend`
- Check admin plugin in medusa-config.ts

### Docker Issues

**Port conflicts:**
```bash
docker-compose down
# Change ports in docker-compose.yml
docker-compose up -d
```

**Database data persists after down:**
```bash
docker-compose down -v  # Remove volumes
```

## Testing

Currently, testing infrastructure is not set up. Recommended additions:

**Frontend:**
- Vitest for unit tests
- Playwright for E2E tests

**Backend:**
- Jest for unit/integration tests
- Supertest for API testing

## Performance Optimization

**Frontend:**
- Images: Use Astro's Image component
- Code splitting: Astro does this automatically
- Lazy loading: Use client:load directives

**Backend:**
- Redis caching for frequently accessed data
- Database indexes on commonly queried fields
- Rate limiting for API endpoints

## Security Considerations

1. **Never commit .env files**
2. **Use strong JWT_SECRET and COOKIE_SECRET in production**
3. **Enable HTTPS in production**
4. **Validate all user inputs**
5. **Keep dependencies updated**
6. **Use Stripe test mode for development**
7. **Implement rate limiting**
8. **Enable CORS only for trusted domains**

## Contributing

1. Create feature branch
2. Make changes
3. Test locally
4. Submit pull request

## Support & Resources

- Astro Docs: https://docs.astro.build
- Medusa Docs: https://docs.medusajs.com
- Tailwind Docs: https://tailwindcss.com/docs
- Railway Docs: https://docs.railway.app
- Stripe Docs: https://stripe.com/docs

## License

MIT

## Contact

For questions or support, please contact the development team.

---

## Last Session Updates

### Session: October 26, 2025 - Product Catalog & Cloudinary Integration

**What Was Accomplished:**

1. **Complete Product Catalog System**
   - Created 13 products across 4 categories (Compost, Mulch, Soil, Specialty)
   - Built `/scripts/parse-products.js` for structured product data generation
   - Generated `/data/products.json` with full product catalog
   - Created TypeScript utilities in `/frontend/src/lib/products.ts`

2. **Cloudinary Image Integration**
   - Configured Cloudinary SDK with `southland-organics` cloud
   - Built `CloudinaryImage.astro` component with responsive srcset
   - Created `ProductImage.astro` wrapper for product photos
   - Migrated 20 product images to Cloudinary (`Soul Miner's/products/{category}/`)
   - Fixed URL encoding for paths with spaces and special characters
   - Generated `image-url-mapping.json` for image reference

3. **Product Components & Pages**
   - Created `ProductCard.astro` (3 variants: default, compact, featured)
   - Built `MaterialCalculator.astro` for cubic yards conversion (HIGH-CONVERSION)
   - Created 18 total product pages:
     - Products index with filtering & search
     - 13 dynamic product detail pages via `[slug].astro`
     - 4 category landing pages (compost, mulch, soil, specialty)

4. **Homepage Integration**
   - Replaced placeholder products with real ProductCard components
   - Integrated MaterialCalculator directly on homepage
   - Connected real Cloudinary images with proper srcset
   - Featured products: Humus Compost ($25), Brown Mulch ($32), Topsoil ($30)

5. **Logo Integration**
   - Replaced placeholder logos with actual SME-Logo.svg
   - Updated Header and Footer components
   - Copied logo to `/frontend/public/logo/` (3 variants)

**Current Working State:**

✅ **Working:**
- All 18 product pages loading correctly
- Cloudinary images displaying with proper encoding
- Product filtering and search functionality
- MaterialCalculator working on homepage and product pages
- Responsive design throughout
- Category navigation
- Real product data from JSON catalog

⚠️ **Not Yet Implemented:**
- Backend Medusa integration (placeholder only)
- Shopping cart functionality
- Checkout process
- Land management services pages (`/land-management`)
- Resources pages (`/resources/calculator`, `/about`, `/contact`)
- Contractor program page

**Key Technical Details:**

- **Cloudinary Public IDs:** Full path is `Soul Miner's/products/{category}/{image}.jpg.jpg`
  - Note: Double `.jpg` extension due to migration script
  - URL encoding implemented in `buildCloudinaryUrl()` function
- **Product Data Structure:** TypeScript interfaces in `/frontend/src/lib/products.ts`
- **Image Component:** Handles responsive srcset, lazy loading, and fallbacks
- **Material Calculator:** Calculates cubic yards: `(L × W × (D/12)) / 27`

**New Configuration:**

Environment variables added to `frontend/.env`:
```env
PUBLIC_CLOUDINARY_CLOUD_NAME=southland-organics
PUBLIC_CLOUDINARY_API_KEY=246196521633339
CLOUDINARY_API_SECRET=vQLdl6oOHdhvLgQqC8CnfqAxjAY
PUBLIC_CLOUDINARY_FOLDER=Soul Miner's
```

**Blockers/Issues Resolved:**

1. ✅ Cloudinary images not showing - Fixed by:
   - Adding `Soul Miner's/` prefix to all image paths
   - Adding `.jpg` extension to match actual uploads (`.jpg.jpg`)
   - Implementing URL encoding in cloudinary.ts

2. ✅ Tailwind v4 `@apply` errors - Resolved by using `@theme` directive and direct CSS

**TODOs for Next Session:**

1. **Missing Product Images:** 3 images not found locally during migration:
   - `natural-mulch-action.jpg`
   - `red-mulch-application.jpg`
   - `sod-soil.jpg`

2. **Live Website Image Migration:** Images were migrated from LOCAL folder, not from soulminerseden.com website. Consider scraping live site if needed.

3. **High Priority Pages:**
   - Land management services pages (NEW $10k/month revenue stream)
   - Resources section (calculator, contractor program)
   - Contact and About pages

4. **Backend Integration:**
   - Connect product catalog to Medusa backend
   - Implement shopping cart with Medusa API
   - Set up checkout flow

5. **SEO & Content:**
   - Migrate remaining content from live site
   - Optimize meta tags and Schema.org markup
   - Set up sitemap generation

**Files Modified This Session:**

Core Files:
- `/scripts/parse-products.js` - Product catalog generator
- `/scripts/migrate-product-images.js` - Cloudinary upload script
- `/data/products.json` - Generated product catalog
- `/frontend/src/lib/products.ts` - Product utilities
- `/frontend/src/lib/cloudinary.ts` - Cloudinary helper (URL encoding fix)

Components:
- `/frontend/src/components/products/ProductCard.astro`
- `/frontend/src/components/products/MaterialCalculator.astro`
- `/frontend/src/components/CloudinaryImage.astro`
- `/frontend/src/components/ProductImage.astro`
- `/frontend/src/components/Header.astro` - Logo update
- `/frontend/src/components/Footer.astro` - Logo update

Pages:
- `/frontend/src/pages/index.astro` - Homepage with real products
- `/frontend/src/pages/products/index.astro` - Product catalog
- `/frontend/src/pages/products/[slug].astro` - Dynamic product pages
- `/frontend/src/pages/products/compost.astro` - Compost category
- `/frontend/src/pages/products/mulch.astro` - Mulch category
- `/frontend/src/pages/products/soil.astro` - Soil category
- `/frontend/src/pages/products/specialty.astro` - Specialty category

Assets:
- `/frontend/public/logo/soul-miners-eden-primary.svg`
- `/frontend/public/logo/soul-miners-eden-secondary.svg`
- `/frontend/public/favicon.svg`
- `/SME-Logo.svg` (project root)

**Important Notes:**

1. **Image Paths:** All Cloudinary paths must include `Soul Miner's/` prefix and have `.jpg.jpg` extension
2. **URL Encoding:** The `buildCloudinaryUrl()` function in cloudinary.ts handles space encoding automatically
3. **Product Slugs:** Used for routing - must match the slug in products.json
4. **Git:** Repository initialized, first commit created, ready to push to https://github.com/mikeusry/sme

```

This comprehensive documentation should help anyone working on the project understand the architecture, development workflow, and deployment process.
