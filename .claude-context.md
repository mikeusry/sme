# Soul Miners - Project Documentation

## Project Overview

Soul Miners is a modern e-commerce platform built with:
- **Frontend**: Astro + Tailwind CSS
- **Backend**: Medusa (Node.js e-commerce framework)
- **Database**: PostgreSQL
- **Cache/Events**: Redis
- **Payments**: Stripe
- **Fulfillment**: Custom local delivery + Manual fulfillment
- **Deployment**: Vercel (frontend) + Railway (backend)
- **Containerization**: Docker

## Project Structure

```
Soul-Miners-Eden/
├── frontend/                 # Astro frontend application
│   ├── src/
│   │   ├── components/      # Reusable UI components
│   │   │   ├── Header.astro
│   │   │   └── Footer.astro
│   │   ├── layouts/         # Page layouts
│   │   │   ├── BaseLayout.astro
│   │   │   └── MainLayout.astro
│   │   ├── pages/           # Astro pages (file-based routing)
│   │   │   ├── index.astro  # Homepage
│   │   │   ├── products/    # Products pages
│   │   │   ├── cart.astro
│   │   │   └── checkout.astro
│   │   ├── lib/             # Utility functions
│   │   │   └── medusa.ts    # Medusa API client & helpers
│   │   └── styles/
│   │       └── global.css   # Global styles with Tailwind
│   ├── tailwind.config.js   # Tailwind configuration
│   ├── astro.config.mjs     # Astro configuration
│   ├── .env.example         # Environment variables template
│   └── package.json
│
├── backend/                 # Medusa backend application
│   ├── src/
│   │   ├── api/            # Custom API endpoints
│   │   ├── services/       # Business logic services
│   │   │   └── local-delivery-fulfillment.ts
│   │   ├── models/         # Database models
│   │   ├── repositories/   # Data access layer
│   │   └── subscribers/    # Event subscribers
│   ├── data/               # Seed data
│   ├── medusa-config.ts    # Medusa configuration
│   ├── tsconfig.json       # TypeScript configuration
│   ├── Dockerfile          # Docker image definition
│   ├── .dockerignore       # Docker ignore file
│   ├── railway.json        # Railway deployment config
│   ├── .env.example        # Environment variables template
│   ├── RAILWAY_DEPLOYMENT.md # Railway deployment guide
│   └── package.json
│
├── docker-compose.yml      # Local development environment
├── package.json            # Monorepo root package.json
├── .gitignore             # Git ignore file
└── README.md              # This file

## Tech Stack Details

### Frontend (Astro + Tailwind CSS)

**Why Astro?**
- Zero JavaScript by default (faster load times)
- Partial hydration for interactive components
- File-based routing
- Excellent SEO
- TypeScript support

**Tailwind CSS Configuration:**
- Custom color palette (primary, secondary)
- Custom fonts (Inter, Poppins)
- Utility components (buttons, cards, inputs)
- Responsive design utilities
- Plugins: @tailwindcss/forms, @tailwindcss/typography

**Key Features:**
- Server-side rendering (SSR) for dynamic content
- Static site generation (SSG) where possible
- Medusa JS SDK integration for API calls
- Cart management via localStorage + API

### Backend (Medusa)

**Why Medusa?**
- Open-source, headless commerce platform
- Built on Node.js
- Extensive API for products, carts, orders
- Plugin architecture
- Built-in admin dashboard
- TypeORM for database management

**Plugins Configured:**
1. **@medusajs/admin**: Admin dashboard
2. **medusa-payment-stripe**: Stripe payment integration
3. **medusa-payment-manual**: Manual payment processing
4. **medusa-fulfillment-manual**: Basic fulfillment
5. **Custom local delivery**: Custom fulfillment provider for local delivery

**Custom Local Delivery Provider:**
- Three delivery options:
  - Standard (3-5 business days) - $5.99
  - Express (1-2 business days) - $12.99
  - Same Day (before 2 PM) - $19.99
- Free delivery over $50
- Service area validation (customizable)
- Located at: `backend/src/services/local-delivery-fulfillment.ts`

### Database & Caching

**PostgreSQL:**
- Primary database for all Medusa data
- Tables managed by TypeORM migrations
- Connection via DATABASE_URL environment variable

**Redis:**
- Cache layer for improved performance
- Event bus for async operations
- Session storage

## Development Workflow

### Prerequisites

- Node.js >= 18.0.0
- npm >= 9.0.0
- Docker & Docker Compose
- PostgreSQL (if not using Docker)
- Redis (if not using Docker)

### Local Development Setup

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd Soul-Miners-Eden
   ```

2. **Install dependencies**
   ```bash
   npm install
   ```

3. **Set up environment variables**

   Frontend:
   ```bash
   cd frontend
   cp .env.example .env
   # Edit .env with your values
   ```

   Backend:
   ```bash
   cd ../backend
   cp .env.example .env
   # Edit .env with your values
   ```

4. **Start Docker services** (PostgreSQL + Redis + Medusa)
   ```bash
   docker-compose up -d
   ```

5. **Run database migrations**
   ```bash
   npm run migrate --workspace=backend
   ```

6. **Start development servers**
   ```bash
   npm run dev
   ```

   This starts:
   - Frontend: http://localhost:4321
   - Backend API: http://localhost:9000
   - Admin Dashboard: http://localhost:9000/app

### Without Docker

If you prefer to run services locally:

1. Start PostgreSQL (ensure it's running on port 5432)
2. Start Redis (ensure it's running on port 6379)
3. Update `.env` files with correct connection strings
4. Run migrations: `npm run migrate --workspace=backend`
5. Start dev servers: `npm run dev`

## API Integration

The frontend communicates with Medusa via the Medusa JS SDK.

**Client Initialization:**
Location: `frontend/src/lib/medusa.ts`

**Available Functions:**
- `getProducts()` - List all products
- `getProduct(id)` - Get single product
- `getProductByHandle(handle)` - Get product by URL slug
- `getCollections()` - List collections
- `createCart()` - Create shopping cart
- `addToCart(cartId, variantId, quantity)` - Add item to cart
- `updateCartItem()` - Update cart item quantity
- `removeFromCart()` - Remove item from cart
- `completeCart()` - Create order from cart
- `searchProducts(query)` - Search products

**Example Usage:**
```typescript
import { getProducts, addToCart } from '../lib/medusa'

// Fetch products
const { products } = await getProducts({ limit: 20 })

// Add to cart
const cart = await addToCart(cartId, variantId, 1)
```

## Deployment

### Frontend Deployment (Vercel)

1. Connect your repository to Vercel
2. Set build settings:
   - Build Command: `npm run build --workspace=frontend`
   - Output Directory: `frontend/dist`
   - Install Command: `npm install`
3. Add environment variables:
   - `PUBLIC_MEDUSA_BACKEND_URL`: Your Railway backend URL
   - `PUBLIC_STRIPE_PUBLISHABLE_KEY`: Stripe public key
4. Deploy

### Backend Deployment (Railway)

See detailed guide: `backend/RAILWAY_DEPLOYMENT.md`

**Quick Steps:**
1. Install Railway CLI: `npm install -g @railway/cli`
2. Login: `railway login`
3. Create project: `railway init`
4. Add PostgreSQL database service
5. Add Redis service
6. Configure environment variables
7. Deploy: `railway up`

**Required Environment Variables:**
- `DATABASE_URL`: Provided by Railway PostgreSQL
- `REDIS_URL`: Provided by Railway Redis
- `JWT_SECRET`: Generate secure random string
- `COOKIE_SECRET`: Generate secure random string
- `STRIPE_API_KEY`: Your Stripe secret key
- `STRIPE_WEBHOOK_SECRET`: Stripe webhook secret
- `MEDUSA_BACKEND_URL`: Your Railway app URL
- `ADMIN_EMAIL`: Admin user email
- `ADMIN_PASSWORD`: Admin user password

## Docker Commands

**Start all services:**
```bash
docker-compose up -d
```

**Stop all services:**
```bash
docker-compose down
```

**View logs:**
```bash
docker-compose logs -f
```

**Rebuild backend:**
```bash
docker-compose up -d --build backend
```

**Access database:**
```bash
docker-compose exec postgres psql -U postgres -d soul_miners_medusa
```

## Admin Dashboard

Access the Medusa admin at: `http://localhost:9000/app`

**First-time Setup:**
1. Create admin user account
2. Set up regions and currencies
3. Add products and collections
4. Configure shipping options
5. Set up payment providers

**Managing Products:**
- Go to Products > Add Product
- Upload images
- Set variants (size, color, etc.)
- Configure pricing
- Add to collections

**Managing Orders:**
- View all orders in Orders section
- Process fulfillments
- Handle refunds and exchanges

## Environment Variables Reference

### Frontend (.env)

```env
PUBLIC_MEDUSA_BACKEND_URL=http://localhost:9000
PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
PUBLIC_SITE_NAME=Soul Miners
PUBLIC_SITE_URL=http://localhost:4321
```

### Backend (.env)

```env
# Database
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/soul_miners_medusa

# Redis
REDIS_URL=redis://localhost:6379

# Security
JWT_SECRET=supersecret
COOKIE_SECRET=supersecret

# Stripe
STRIPE_API_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# CORS
STORE_CORS=http://localhost:4321
ADMIN_CORS=http://localhost:9000
```

## Customization Guide

### Adding New Pages

1. Create file in `frontend/src/pages/`
2. Use MainLayout for consistent header/footer
3. Import Medusa utilities as needed

Example:
```astro
---
import MainLayout from '../layouts/MainLayout.astro'
import { getProducts } from '../lib/medusa'

const { products } = await getProducts()
---

<MainLayout title="My Page">
  <!-- Your content -->
</MainLayout>
```

### Creating Custom API Endpoints

1. Create file in `backend/src/api/`
2. Follow Medusa API conventions
3. Export GET, POST, etc. handlers

### Adding Custom Services

1. Create file in `backend/src/services/`
2. Extend Medusa base services
3. Inject via dependency injection

### Styling Components

Use Tailwind utility classes or add custom CSS in `global.css`

## Troubleshooting

### Frontend Issues

**Module not found errors:**
```bash
cd frontend && npm install
```

**Tailwind styles not applying:**
- Check `astro.config.mjs` has Tailwind plugin
- Verify `global.css` is imported in layouts

### Backend Issues

**Database connection failed:**
- Verify PostgreSQL is running
- Check DATABASE_URL in .env
- Ensure database exists

**Redis connection failed:**
- Verify Redis is running
- Check REDIS_URL in .env

**Admin dashboard not loading:**
- Run `npm run build --workspace=backend`
- Check admin plugin in medusa-config.ts

### Docker Issues

**Port conflicts:**
```bash
docker-compose down
# Change ports in docker-compose.yml
docker-compose up -d
```

**Database data persists after down:**
```bash
docker-compose down -v  # Remove volumes
```

## Testing

Currently, testing infrastructure is not set up. Recommended additions:

**Frontend:**
- Vitest for unit tests
- Playwright for E2E tests

**Backend:**
- Jest for unit/integration tests
- Supertest for API testing

## Performance Optimization

**Frontend:**
- Images: Use Astro's Image component
- Code splitting: Astro does this automatically
- Lazy loading: Use client:load directives

**Backend:**
- Redis caching for frequently accessed data
- Database indexes on commonly queried fields
- Rate limiting for API endpoints

## Security Considerations

1. **Never commit .env files**
2. **Use strong JWT_SECRET and COOKIE_SECRET in production**
3. **Enable HTTPS in production**
4. **Validate all user inputs**
5. **Keep dependencies updated**
6. **Use Stripe test mode for development**
7. **Implement rate limiting**
8. **Enable CORS only for trusted domains**

## Contributing

1. Create feature branch
2. Make changes
3. Test locally
4. Submit pull request

## Support & Resources

- Astro Docs: https://docs.astro.build
- Medusa Docs: https://docs.medusajs.com
- Tailwind Docs: https://tailwindcss.com/docs
- Railway Docs: https://docs.railway.app
- Stripe Docs: https://stripe.com/docs

## License

MIT

## Contact

For questions or support, please contact the development team.
```

This comprehensive documentation should help anyone working on the project understand the architecture, development workflow, and deployment process.
