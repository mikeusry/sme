---
/**
 * Shopping Cart Page
 *
 * Dynamic cart with line items, quantity updates, and checkout CTA.
 * Client-side rendered using cart store.
 */
import MainLayout from '../layouts/MainLayout.astro';
---

<MainLayout title="Shopping Cart" description="Review your cart and checkout">
  <div class="container-custom py-12">
    <h1 class="text-4xl font-display font-bold mb-8">Shopping Cart</h1>

    <!-- Loading State -->
    <div id="cart-loading" class="text-center py-12">
      <div class="inline-flex items-center gap-3 text-warm-600">
        <svg class="w-6 h-6 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Loading cart...</span>
      </div>
    </div>

    <!-- Empty Cart State -->
    <div id="cart-empty" class="hidden">
      <div class="card text-center py-12">
        <svg class="w-16 h-16 mx-auto text-warm-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <h2 class="text-2xl font-display font-bold text-warm-900 mb-2">Your cart is empty</h2>
        <p class="text-warm-600 mb-6">Looks like you haven't added any products yet.</p>
        <a href="/products" class="btn-primary inline-block">Browse Products</a>
      </div>
    </div>

    <!-- Cart Content -->
    <div id="cart-content" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cart Items -->
        <div class="lg:col-span-2">
          <div class="card">
            <div class="divide-y divide-warm-200" id="cart-items">
              <!-- Items rendered via JS -->
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
          <div class="card sticky top-6">
            <h2 class="text-2xl font-display font-bold mb-6">Order Summary</h2>

            <div class="space-y-3 mb-6">
              <div class="flex justify-between text-warm-700">
                <span>Subtotal</span>
                <span id="cart-subtotal">$0.00</span>
              </div>
              <div class="flex justify-between text-warm-700">
                <span>Shipping</span>
                <span id="cart-shipping" class="text-sm text-warm-500">Calculated at checkout</span>
              </div>
              <div class="flex justify-between text-warm-700">
                <span>Tax</span>
                <span id="cart-tax">$0.00</span>
              </div>
              <div class="flex justify-between font-bold text-xl pt-4 border-t border-warm-200">
                <span>Total</span>
                <span id="cart-total">$0.00</span>
              </div>
            </div>

            <a
              href="/checkout"
              id="checkout-btn"
              class="btn-primary w-full text-center text-lg py-4 block"
            >
              Proceed to Checkout
            </a>

            <p class="text-sm text-warm-500 mt-4 text-center">
              Shipping calculated based on delivery location
            </p>

            <!-- Delivery Info -->
            <div class="mt-6 pt-6 border-t border-warm-200">
              <h3 class="font-semibold text-warm-900 mb-2">Delivery Options</h3>
              <ul class="text-sm text-warm-600 space-y-1">
                <li>Local Delivery: $40 base + $1.25/mile after 20 miles</li>
                <li>Pickup: 189 Luke Road, Bogart, GA 30622</li>
              </ul>
            </div>

            <!-- Contact -->
            <div class="mt-4 pt-4 border-t border-warm-200">
              <p class="text-sm text-warm-600">
                Questions? Call <a href="tel:+17066134415" class="text-primary-600 font-semibold">(706) 613-4415</a>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Continue Shopping -->
      <div class="mt-8 text-center">
        <a href="/products" class="text-primary-600 font-semibold hover:text-primary-700 transition-colors">
          ← Continue Shopping
        </a>
      </div>
    </div>

    <!-- Error State -->
    <div id="cart-error" class="hidden">
      <div class="card text-center py-12 bg-red-50 border-red-200">
        <svg class="w-16 h-16 mx-auto text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h2 class="text-2xl font-display font-bold text-red-900 mb-2">Something went wrong</h2>
        <p class="text-red-600 mb-6" id="error-message">Failed to load cart</p>
        <button onclick="location.reload()" class="btn-primary">Try Again</button>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  import { initializeCart, getCurrentCart, updateItemQuantity, removeItemFromCart, subscribeToCart, formatCartTotal, formatLineItemPrice } from '../lib/cart-store';
  import type { Cart, LineItem } from '../lib/medusa-v2';

  const loadingEl = document.getElementById('cart-loading');
  const emptyEl = document.getElementById('cart-empty');
  const contentEl = document.getElementById('cart-content');
  const errorEl = document.getElementById('cart-error');
  const cartItemsEl = document.getElementById('cart-items');
  const subtotalEl = document.getElementById('cart-subtotal');
  const taxEl = document.getElementById('cart-tax');
  const totalEl = document.getElementById('cart-total');
  const errorMessageEl = document.getElementById('error-message');

  function formatPrice(amount: number, currencyCode: string = 'usd'): string {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: currencyCode.toUpperCase(),
    }).format(amount / 100);
  }

  function showState(state: 'loading' | 'empty' | 'content' | 'error') {
    loadingEl?.classList.toggle('hidden', state !== 'loading');
    emptyEl?.classList.toggle('hidden', state !== 'empty');
    contentEl?.classList.toggle('hidden', state !== 'content');
    errorEl?.classList.toggle('hidden', state !== 'error');
  }

  function renderCartItem(item: LineItem, currencyCode: string): string {
    return `
      <div class="cart-item flex gap-4 py-6" data-line-item-id="${item.id}">
        <!-- Thumbnail -->
        <div class="w-24 h-24 bg-warm-100 rounded-lg overflow-hidden flex-shrink-0">
          ${item.thumbnail
            ? `<img src="${item.thumbnail}" alt="${item.title}" class="w-full h-full object-cover" />`
            : `<div class="w-full h-full flex items-center justify-center text-warm-400">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>`
          }
        </div>

        <!-- Details -->
        <div class="flex-grow">
          <h3 class="font-semibold text-warm-900">${item.title}</h3>
          ${item.description ? `<p class="text-sm text-warm-600">${item.description}</p>` : ''}
          <p class="text-sm text-warm-500 mt-1">Unit price: ${formatPrice(item.unit_price, currencyCode)}</p>
        </div>

        <!-- Quantity & Remove -->
        <div class="flex flex-col items-end gap-2">
          <div class="flex items-center border border-warm-300 rounded-lg">
            <button
              type="button"
              class="qty-decrease px-3 py-1 text-warm-600 hover:bg-warm-100 transition-colors"
              data-line-item-id="${item.id}"
              data-current-qty="${item.quantity}"
            >
              −
            </button>
            <span class="px-3 py-1 font-semibold text-warm-900 min-w-[2rem] text-center">${item.quantity}</span>
            <button
              type="button"
              class="qty-increase px-3 py-1 text-warm-600 hover:bg-warm-100 transition-colors"
              data-line-item-id="${item.id}"
              data-current-qty="${item.quantity}"
            >
              +
            </button>
          </div>
          <span class="font-semibold text-warm-900">${formatPrice(item.total, currencyCode)}</span>
          <button
            type="button"
            class="remove-item text-red-600 text-sm hover:text-red-700 transition-colors"
            data-line-item-id="${item.id}"
          >
            Remove
          </button>
        </div>
      </div>
    `;
  }

  function renderCart(cart: Cart | null) {
    if (!cart || cart.items.length === 0) {
      showState('empty');
      return;
    }

    showState('content');

    // Render items
    if (cartItemsEl) {
      cartItemsEl.innerHTML = cart.items.map(item => renderCartItem(item, cart.currency_code)).join('');

      // Attach event listeners
      cartItemsEl.querySelectorAll('.qty-decrease').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget as HTMLElement;
          const lineItemId = target.dataset.lineItemId;
          const currentQty = parseInt(target.dataset.currentQty || '1');
          if (lineItemId && currentQty > 1) {
            await updateItemQuantity(lineItemId, currentQty - 1);
          }
        });
      });

      cartItemsEl.querySelectorAll('.qty-increase').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget as HTMLElement;
          const lineItemId = target.dataset.lineItemId;
          const currentQty = parseInt(target.dataset.currentQty || '1');
          if (lineItemId) {
            await updateItemQuantity(lineItemId, currentQty + 1);
          }
        });
      });

      cartItemsEl.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget as HTMLElement;
          const lineItemId = target.dataset.lineItemId;
          if (lineItemId) {
            await removeItemFromCart(lineItemId);
          }
        });
      });
    }

    // Update totals
    if (subtotalEl) subtotalEl.textContent = formatPrice(cart.subtotal, cart.currency_code);
    if (taxEl) taxEl.textContent = formatPrice(cart.tax_total, cart.currency_code);
    if (totalEl) totalEl.textContent = formatPrice(cart.total, cart.currency_code);
  }

  // Subscribe to cart updates
  subscribeToCart((cart, isLoading) => {
    if (isLoading) {
      showState('loading');
    } else {
      renderCart(cart);
    }
  });

  // Initialize cart on page load
  async function init() {
    try {
      showState('loading');
      const cart = await initializeCart();
      renderCart(cart);
    } catch (error: any) {
      console.error('Failed to load cart:', error);
      if (errorMessageEl) errorMessageEl.textContent = error.message || 'Failed to load cart';
      showState('error');
    }
  }

  init();
</script>

<style>
  .cart-item {
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
