---
/**
 * Checkout Page with Pickup Scheduling
 *
 * Multi-step checkout flow:
 * 1. Contact Info (email)
 * 2. Fulfillment Method (Pickup vs Delivery) + Pickup Time Selection
 * 3. Shipping Address (if delivery selected)
 * 4. Payment
 */
import MainLayout from '../layouts/MainLayout.astro';
import FulfillmentChoice from '../components/checkout/FulfillmentChoice.astro';
import PickupTimeSlot from '../components/checkout/PickupTimeSlot.astro';
---

<MainLayout title="Checkout" description="Complete your order">
  <div class="container-custom py-12">
    <h1 class="text-4xl font-display font-bold mb-8">Checkout</h1>

    <!-- Loading State -->
    <div id="checkout-loading" class="text-center py-12">
      <div class="inline-flex items-center gap-3 text-warm-600">
        <svg class="w-6 h-6 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Loading checkout...</span>
      </div>
    </div>

    <!-- Empty Cart Redirect -->
    <div id="checkout-empty" class="hidden">
      <div class="card text-center py-12">
        <svg class="w-16 h-16 mx-auto text-warm-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <h2 class="text-2xl font-display font-bold text-warm-900 mb-2">Your cart is empty</h2>
        <p class="text-warm-600 mb-6">Add some products before checking out.</p>
        <a href="/products" class="btn-primary inline-block">Browse Products</a>
      </div>
    </div>

    <!-- Checkout Content -->
    <div id="checkout-content" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Checkout Form -->
        <div class="lg:col-span-2">
          <!-- Progress Steps -->
          <div class="flex items-center justify-between mb-8">
            <div class="checkout-step active" data-step="1">
              <div class="step-number">1</div>
              <span class="step-label">Contact</span>
            </div>
            <div class="step-line"></div>
            <div class="checkout-step" data-step="2">
              <div class="step-number">2</div>
              <span class="step-label">Fulfillment</span>
            </div>
            <div class="step-line"></div>
            <div class="checkout-step" data-step="3">
              <div class="step-number">3</div>
              <span class="step-label">Address</span>
            </div>
            <div class="step-line"></div>
            <div class="checkout-step" data-step="4">
              <div class="step-number">4</div>
              <span class="step-label">Payment</span>
            </div>
          </div>

          <!-- Step 1: Contact Info -->
          <div id="step-1" class="checkout-step-content card">
            <h2 class="text-2xl font-display font-bold mb-6">Contact Information</h2>

            <form id="contact-form" class="space-y-4">
              <div>
                <label for="email" class="block text-sm font-medium text-warm-700 mb-1">Email Address</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  class="input w-full"
                  placeholder="you@example.com"
                />
                <p class="text-xs text-warm-500 mt-1">We'll send order confirmation and pickup details here</p>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="first_name_contact" class="block text-sm font-medium text-warm-700 mb-1">First Name</label>
                  <input type="text" id="first_name_contact" name="first_name" required class="input w-full" />
                </div>
                <div>
                  <label for="last_name_contact" class="block text-sm font-medium text-warm-700 mb-1">Last Name</label>
                  <input type="text" id="last_name_contact" name="last_name" required class="input w-full" />
                </div>
              </div>

              <div>
                <label for="phone_contact" class="block text-sm font-medium text-warm-700 mb-1">Phone Number</label>
                <input type="tel" id="phone_contact" name="phone" required class="input w-full" placeholder="(706) 555-0123" />
                <p class="text-xs text-warm-500 mt-1">In case we need to reach you about your order</p>
              </div>

              <div class="pt-4">
                <button type="submit" class="btn-primary w-full text-lg py-4">
                  Continue to Fulfillment
                </button>
              </div>
            </form>
          </div>

          <!-- Step 2: Fulfillment Method & Pickup Scheduling -->
          <div id="step-2" class="checkout-step-content card hidden">
            <FulfillmentChoice />
            <PickupTimeSlot />

            <div class="pt-6 flex gap-4">
              <button type="button" id="back-to-contact" class="btn-outline flex-1 py-3">
                Back
              </button>
              <button type="button" id="continue-to-address" class="btn-primary flex-1 py-3">
                Continue
              </button>
            </div>
          </div>

          <!-- Step 3: Shipping Address (conditional) -->
          <div id="step-3" class="checkout-step-content card hidden">
            <h2 class="text-2xl font-display font-bold mb-6">Shipping Address</h2>

            <form id="address-form" class="space-y-4">
              <div>
                <label for="address_1" class="block text-sm font-medium text-warm-700 mb-1">Address</label>
                <input type="text" id="address_1" name="address_1" required class="input w-full" placeholder="Street address" />
              </div>

              <div>
                <label for="address_2" class="block text-sm font-medium text-warm-700 mb-1">Apartment, suite, etc. (optional)</label>
                <input type="text" id="address_2" name="address_2" class="input w-full" />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="city" class="block text-sm font-medium text-warm-700 mb-1">City</label>
                  <input type="text" id="city" name="city" required class="input w-full" />
                </div>
                <div>
                  <label for="province" class="block text-sm font-medium text-warm-700 mb-1">State</label>
                  <select id="province" name="province" required class="input w-full">
                    <option value="">Select state</option>
                    <option value="GA">Georgia</option>
                    <option value="AL">Alabama</option>
                    <option value="FL">Florida</option>
                    <option value="NC">North Carolina</option>
                    <option value="SC">South Carolina</option>
                    <option value="TN">Tennessee</option>
                  </select>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="postal_code" class="block text-sm font-medium text-warm-700 mb-1">ZIP Code</label>
                  <input type="text" id="postal_code" name="postal_code" required class="input w-full" pattern="[0-9]{5}" />
                </div>
                <div>
                  <label for="phone_address" class="block text-sm font-medium text-warm-700 mb-1">Phone</label>
                  <input type="tel" id="phone_address" name="phone" required class="input w-full" placeholder="(706) 555-0123" />
                </div>
              </div>

              <div class="pt-4 flex gap-4">
                <button type="button" id="back-to-fulfillment" class="btn-outline flex-1 py-3">
                  Back
                </button>
                <button type="submit" class="btn-primary flex-1 py-3">
                  Continue to Payment
                </button>
              </div>
            </form>
          </div>

          <!-- Step 4: Payment -->
          <div id="step-4" class="checkout-step-content card hidden">
            <h2 class="text-2xl font-display font-bold mb-6">Payment</h2>

            <div class="bg-accent-50 border border-accent-200 rounded-lg p-6 mb-6">
              <div class="flex gap-4">
                <svg class="w-12 h-12 flex-shrink-0 text-accent-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
                <div>
                  <h3 class="font-bold text-warm-900 text-lg mb-2">Complete Your Order by Phone</h3>
                  <p class="text-warm-700 mb-3">
                    Call us to finalize payment and confirm your <span id="payment-fulfillment-type">pickup</span> details:
                  </p>
                  <a href="tel:+17066134415" class="inline-flex items-center gap-2 text-2xl font-bold text-accent-600 hover:text-accent-700 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                    </svg>
                    (706) 613-4415
                  </a>
                  <p class="text-sm text-warm-500 mt-3">
                    Monday-Friday: 9 AM - 5 PM ET<br/>
                    We accept cash, check, Venmo, and credit cards
                  </p>
                </div>
              </div>
            </div>

            <!-- Order Summary -->
            <div class="bg-warm-50 border border-warm-200 rounded-lg p-6" id="payment-summary">
              <h3 class="font-semibold text-warm-900 mb-4">Your Order Details</h3>
              <!-- Populated via JavaScript -->
            </div>

            <div class="pt-6 flex gap-4">
              <button type="button" id="back-to-address" class="btn-outline flex-1 py-3">
                Back
              </button>
              <button type="button" id="place-order" class="btn-primary flex-1 py-3">
                Place Order (Call to Pay)
              </button>
            </div>
          </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="lg:col-span-1">
          <div class="card sticky top-6">
            <h2 class="text-xl font-display font-bold mb-4">Order Summary</h2>

            <div id="checkout-items" class="divide-y divide-warm-200 mb-4 max-h-[300px] overflow-y-auto">
              <!-- Items rendered via JS -->
            </div>

            <div class="space-y-2 pt-4 border-t border-warm-200">
              <div class="flex justify-between text-warm-700">
                <span>Subtotal</span>
                <span id="checkout-subtotal">$0.00</span>
              </div>
              <div class="flex justify-between text-warm-700">
                <span>Fulfillment</span>
                <span id="checkout-fulfillment">-</span>
              </div>
              <div class="flex justify-between text-warm-700">
                <span>Tax</span>
                <span id="checkout-tax">$0.00</span>
              </div>
              <div class="flex justify-between font-bold text-xl pt-2 border-t border-warm-200">
                <span>Total</span>
                <span id="checkout-total">$0.00</span>
              </div>
            </div>

            <!-- Fulfillment Summary -->
            <div id="fulfillment-summary" class="mt-4 pt-4 border-t border-warm-200 hidden">
              <h3 class="text-sm font-semibold text-warm-700 mb-2">Fulfillment Details</h3>
              <div id="fulfillment-summary-content" class="text-sm text-warm-600">
                <!-- Populated via JavaScript -->
              </div>
            </div>

            <a href="/cart" class="block text-center text-primary-600 text-sm mt-4 hover:underline">
              Edit Cart
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Success State -->
    <div id="checkout-success" class="hidden">
      <div class="card text-center py-12">
        <svg class="w-20 h-20 mx-auto text-accent-500 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h2 class="text-3xl font-display font-bold text-warm-900 mb-4">Order Confirmed!</h2>
        <p class="text-xl text-warm-600 mb-2">Thank you for your order.</p>
        <p class="text-warm-600 mb-4">
          Order #<span id="order-number" class="font-semibold">-</span>
        </p>

        <div id="pickup-confirmation" class="hidden bg-accent-50 border border-accent-200 rounded-lg p-6 max-w-md mx-auto mb-8">
          <h3 class="font-semibold text-warm-900 mb-3">Pickup Details</h3>
          <div id="pickup-details" class="text-sm text-warm-700 space-y-2">
            <!-- Populated via JavaScript -->
          </div>
        </div>

        <div id="delivery-confirmation" class="hidden bg-accent-50 border border-accent-200 rounded-lg p-6 max-w-md mx-auto mb-8">
          <h3 class="font-semibold text-warm-900 mb-3">Delivery Information</h3>
          <p class="text-sm text-warm-700">
            We'll contact you within 24 hours to schedule delivery.
          </p>
        </div>

        <p class="text-warm-600 mb-8">
          We've sent a confirmation email with details.
        </p>

        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="/products" class="btn-primary">Continue Shopping</a>
          <a href="tel:+17066134415" class="btn-outline">Questions? Call Us</a>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div id="checkout-error" class="hidden">
      <div class="card text-center py-12 bg-red-50 border-red-200">
        <svg class="w-16 h-16 mx-auto text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h2 class="text-2xl font-display font-bold text-red-900 mb-2">Something went wrong</h2>
        <p class="text-red-600 mb-6" id="error-message">Failed to load checkout</p>
        <a href="/cart" class="btn-primary">Return to Cart</a>
      </div>
    </div>
  </div>
</MainLayout>

<style>
  .checkout-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }

  .step-number {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    background: #e5e7eb;
    color: #6b7280;
    transition: all 0.2s;
  }

  .checkout-step.active .step-number,
  .checkout-step.completed .step-number {
    background: var(--color-accent-600, #16a34a);
    color: white;
  }

  .step-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
  }

  .checkout-step.active .step-label {
    color: var(--color-accent-600, #16a34a);
    font-weight: 600;
  }

  .step-line {
    flex: 1;
    height: 2px;
    background: #e5e7eb;
    margin: 0 0.5rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 768px) {
    .checkout-step {
      gap: 0.25rem;
    }

    .step-number {
      width: 2rem;
      height: 2rem;
      font-size: 0.875rem;
    }

    .step-label {
      font-size: 0.75rem;
    }

    .step-line {
      margin: 0 0.25rem;
      margin-bottom: 1rem;
    }
  }
</style>

<script>
  import { initializeCart, getCurrentCart, clearStoredCartId } from '../lib/cart-store';
  import { updateCart, completeCart, type Cart } from '../lib/medusa-v2';
  import { updatePickupSchedule, getPickupSchedule, getFulfillmentSummary, isPickupScheduleComplete, type PickupSchedule, type FulfillmentMethod, type TimeSlot } from '../lib/pickup-scheduling';

  // State
  let cart: Cart | null = null;
  let currentStep = 1;
  let fulfillmentMethod: FulfillmentMethod = 'pickup';
  let pickupSchedule: Partial<PickupSchedule> = { method: 'pickup' };

  // Elements
  const loadingEl = document.getElementById('checkout-loading');
  const emptyEl = document.getElementById('checkout-empty');
  const contentEl = document.getElementById('checkout-content');
  const errorEl = document.getElementById('checkout-error');
  const successEl = document.getElementById('checkout-success');
  const errorMessageEl = document.getElementById('error-message');

  const step1El = document.getElementById('step-1');
  const step2El = document.getElementById('step-2');
  const step3El = document.getElementById('step-3');
  const step4El = document.getElementById('step-4');

  const contactForm = document.getElementById('contact-form') as HTMLFormElement;
  const addressForm = document.getElementById('address-form') as HTMLFormElement;
  const pickupTimeSlotEl = document.getElementById('pickup-time-slot');

  function formatPrice(amount: number, currencyCode: string = 'usd'): string {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: currencyCode.toUpperCase(),
    }).format(amount / 100);
  }

  function showState(state: 'loading' | 'empty' | 'content' | 'error' | 'success') {
    loadingEl?.classList.toggle('hidden', state !== 'loading');
    emptyEl?.classList.toggle('hidden', state !== 'empty');
    contentEl?.classList.toggle('hidden', state !== 'content');
    errorEl?.classList.toggle('hidden', state !== 'error');
    successEl?.classList.toggle('hidden', state !== 'success');
  }

  function showStep(step: number) {
    currentStep = step;

    // Update step indicators
    document.querySelectorAll('.checkout-step').forEach(el => {
      const stepNum = parseInt(el.getAttribute('data-step') || '0');
      el.classList.toggle('active', stepNum === step);
      el.classList.toggle('completed', stepNum < step);
    });

    // Show/hide step content
    step1El?.classList.toggle('hidden', step !== 1);
    step2El?.classList.toggle('hidden', step !== 2);
    step3El?.classList.toggle('hidden', step !== 3);
    step4El?.classList.toggle('hidden', step !== 4);
  }

  function renderOrderSummary() {
    if (!cart) return;

    const itemsEl = document.getElementById('checkout-items');
    if (itemsEl) {
      itemsEl.innerHTML = cart.items.map(item => `
        <div class="flex gap-3 py-3">
          <div class="w-12 h-12 bg-warm-100 rounded flex-shrink-0"></div>
          <div class="flex-grow min-w-0">
            <p class="font-medium text-warm-900 text-sm truncate">${item.title}</p>
            <p class="text-xs text-warm-500">Qty: ${item.quantity}</p>
          </div>
          <span class="text-sm font-medium text-warm-900">${formatPrice(item.total, cart.currency_code)}</span>
        </div>
      `).join('');
    }

    const subtotalEl = document.getElementById('checkout-subtotal');
    const fulfillmentEl = document.getElementById('checkout-fulfillment');
    const taxEl = document.getElementById('checkout-tax');
    const totalEl = document.getElementById('checkout-total');

    if (subtotalEl) subtotalEl.textContent = formatPrice(cart.subtotal, cart.currency_code);
    if (fulfillmentEl) {
      fulfillmentEl.textContent = fulfillmentMethod === 'pickup' ? 'FREE' : 'Calculated';
    }
    if (taxEl) taxEl.textContent = formatPrice(cart.tax_total, cart.currency_code);
    if (totalEl) totalEl.textContent = formatPrice(cart.total, cart.currency_code);

    // Update fulfillment summary
    const summaryEl = document.getElementById('fulfillment-summary');
    const summaryContentEl = document.getElementById('fulfillment-summary-content');
    if (pickupSchedule.method && summaryEl && summaryContentEl) {
      const schedule = getPickupSchedule(cart) || pickupSchedule as PickupSchedule;
      summaryContentEl.innerHTML = `<p>${getFulfillmentSummary(schedule)}</p>`;
      summaryEl.classList.remove('hidden');
    }
  }

  // Step 1: Contact Form
  contactForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(contactForm);

    try {
      if (cart) {
        cart = await updateCart(cart.id, {
          email: formData.get('email') as string,
        });
      }
      showStep(2);
    } catch (error) {
      console.error('Failed to save contact info:', error);
      alert('Failed to save contact information. Please try again.');
    }
  });

  // Step 2: Fulfillment Method Selection
  document.addEventListener('DOMContentLoaded', () => {
    const fulfillmentRadios = document.querySelectorAll('input[name="fulfillment-method"]');

    fulfillmentRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        fulfillmentMethod = target.value as FulfillmentMethod;
        pickupSchedule = { method: fulfillmentMethod };

        // Show/hide pickup time slot
        if (fulfillmentMethod === 'pickup') {
          pickupTimeSlotEl?.classList.remove('hidden');
        } else {
          pickupTimeSlotEl?.classList.add('hidden');
        }

        renderOrderSummary();
      });
    });

    // Pickup date selection
    const pickupDateSelect = document.getElementById('pickup-date') as HTMLSelectElement;
    pickupDateSelect?.addEventListener('change', () => {
      pickupSchedule.pickupDate = pickupDateSelect.value;
      renderOrderSummary();
    });

    // Time slot selection
    const timeSlotRadios = document.querySelectorAll('input[name="time-slot"]');
    timeSlotRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        pickupSchedule.timeSlot = target.value as TimeSlot;
        renderOrderSummary();
      });
    });

    // Pickup notes
    const pickupNotesInput = document.getElementById('pickup-notes') as HTMLTextAreaElement;
    pickupNotesInput?.addEventListener('change', () => {
      pickupSchedule.notes = pickupNotesInput.value;
    });
  });

  // Continue to Address/Payment
  document.getElementById('continue-to-address')?.addEventListener('click', async () => {
    try {
      if (!cart) return;

      // Save pickup schedule to cart metadata
      cart = await updatePickupSchedule(cart.id, pickupSchedule);

      // If delivery, go to address form; if pickup, skip to payment
      if (fulfillmentMethod === 'delivery') {
        showStep(3);
      } else {
        showStep(4);
        updatePaymentSummary();
      }
    } catch (error) {
      console.error('Failed to save fulfillment method:', error);
      alert('Failed to save fulfillment method. Please try again.');
    }
  });

  // Step 3: Address Form (for delivery)
  addressForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(addressForm);

    try {
      if (cart) {
        cart = await updateCart(cart.id, {
          shipping_address: {
            first_name: formData.get('first_name') as string || null,
            last_name: formData.get('last_name') as string || null,
            address_1: formData.get('address_1') as string,
            address_2: formData.get('address_2') as string || null,
            city: formData.get('city') as string,
            province: formData.get('province') as string,
            postal_code: formData.get('postal_code') as string,
            country_code: 'us',
            phone: formData.get('phone') as string || null,
          },
          billing_address: {
            first_name: formData.get('first_name') as string || null,
            last_name: formData.get('last_name') as string || null,
            address_1: formData.get('address_1') as string,
            address_2: formData.get('address_2') as string || null,
            city: formData.get('city') as string,
            province: formData.get('province') as string,
            postal_code: formData.get('postal_code') as string,
            country_code: 'us',
            phone: formData.get('phone') as string || null,
          },
        });
      }
      showStep(4);
      updatePaymentSummary();
    } catch (error) {
      console.error('Failed to save address:', error);
      alert('Failed to save shipping address. Please try again.');
    }
  });

  function updatePaymentSummary() {
    const paymentFulfillmentType = document.getElementById('payment-fulfillment-type');
    const paymentSummary = document.getElementById('payment-summary');

    if (paymentFulfillmentType) {
      paymentFulfillmentType.textContent = fulfillmentMethod;
    }

    if (paymentSummary && cart) {
      const schedule = getPickupSchedule(cart) || pickupSchedule as PickupSchedule;
      paymentSummary.innerHTML = `
        <h3 class="font-semibold text-warm-900 mb-4">Your Order Details</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-warm-600">Email:</span>
            <span class="font-medium">${cart.email || '-'}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-warm-600">Fulfillment:</span>
            <span class="font-medium">${getFulfillmentSummary(schedule)}</span>
          </div>
          <div class="flex justify-between pt-2 border-t border-warm-200">
            <span class="text-warm-600">Order Total:</span>
            <span class="font-bold text-lg">${formatPrice(cart.total, cart.currency_code)}</span>
          </div>
        </div>
      `;
    }
  }

  // Place Order
  document.getElementById('place-order')?.addEventListener('click', async () => {
    try {
      if (!cart) return;

      const btn = document.getElementById('place-order') as HTMLButtonElement;
      btn.disabled = true;
      btn.textContent = 'Processing...';

      // Complete cart
      const result = await completeCart(cart.id);

      // Clear cart
      clearStoredCartId();

      // Show success
      const orderNumberEl = document.getElementById('order-number');
      if (orderNumberEl && result.data?.id) {
        orderNumberEl.textContent = result.data.id;
      }

      // Show appropriate confirmation
      const schedule = getPickupSchedule(cart) || pickupSchedule as PickupSchedule;
      if (schedule.method === 'pickup') {
        const pickupConfirmation = document.getElementById('pickup-confirmation');
        const pickupDetails = document.getElementById('pickup-details');
        if (pickupConfirmation && pickupDetails) {
          pickupDetails.innerHTML = `
            <p><strong>When:</strong> ${getFulfillmentSummary(schedule)}</p>
            <p><strong>Where:</strong> 189 Luke Road, Bogart, GA 30622</p>
            <p class="text-xs mt-2">Honor stand is open 24/7 - access code in confirmation email</p>
          `;
          pickupConfirmation.classList.remove('hidden');
        }
      } else {
        document.getElementById('delivery-confirmation')?.classList.remove('hidden');
      }

      showState('success');
    } catch (error: any) {
      console.error('Failed to place order:', error);
      alert('Failed to place order. Please try again or call us at (706) 613-4415.');
      const btn = document.getElementById('place-order') as HTMLButtonElement;
      btn.disabled = false;
      btn.textContent = 'Place Order (Call to Pay)';
    }
  });

  // Navigation buttons
  document.getElementById('back-to-contact')?.addEventListener('click', () => showStep(1));
  document.getElementById('back-to-fulfillment')?.addEventListener('click', () => showStep(2));
  document.getElementById('back-to-address')?.addEventListener('click', () => {
    if (fulfillmentMethod === 'delivery') {
      showStep(3);
    } else {
      showStep(2);
    }
  });

  // Initialize
  async function init() {
    try {
      showState('loading');
      cart = await initializeCart();

      if (!cart || cart.items.length === 0) {
        showState('empty');
        return;
      }

      // Check for existing pickup schedule
      const existingSchedule = getPickupSchedule(cart);
      if (existingSchedule) {
        pickupSchedule = existingSchedule;
        fulfillmentMethod = existingSchedule.method;
      }

      renderOrderSummary();
      showState('content');
      showStep(1);
    } catch (error: any) {
      console.error('Failed to load checkout:', error);
      if (errorMessageEl) errorMessageEl.textContent = error.message || 'Failed to load checkout';
      showState('error');
    }
  }

  init();
</script>
