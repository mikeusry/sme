---
/**
 * Site Review - AI Detection
 *
 * Live AI detection for Vercel and localhost
 * Calls /api/scan endpoint which uses Originality.ai
 */

export const prerender = false;

import AdminLayout from '../../layouts/AdminLayout.astro';

// Pages to check
const pagesToCheck = [
  { path: '/', label: 'Home' },
  { path: '/about', label: 'About' },
  { path: '/contact', label: 'Contact' },
  { path: '/products', label: 'Products' },
  { path: '/land-management', label: 'Land Management' },
  { path: '/land-management/how-it-works', label: 'How It Works' },
  { path: '/land-management/services', label: 'Services' },
  { path: '/land-management/request', label: 'Request' },
];

// Environments
const environments = [
  { name: 'Vercel', baseUrl: 'https://sme-frontend-delta.vercel.app' },
  { name: 'Localhost', baseUrl: 'http://localhost:4321' },
];
---

<AdminLayout title="AI Detection" description="Check content for AI detection">
  <!-- Environment Selector -->
  <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
    <label style="font-weight: 500;">Environment:</label>
    <select id="env-select" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
      {environments.map((env, i) => (
        <option value={env.baseUrl} selected={i === 0}>{env.name} ({env.baseUrl})</option>
      ))}
    </select>
    <button id="scan-all-btn" style="background: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 6px; border: none; cursor: pointer; font-size: 0.875rem;">
      Scan All Pages
    </button>
    <span id="scan-status" style="font-size: 0.875rem; color: #6b7280;"></span>
  </div>

  <!-- Thresholds -->
  <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; gap: 2rem; font-size: 0.875rem; flex-wrap: wrap;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <span style="width: 12px; height: 12px; background: #22c55e; border-radius: 50%;"></span>
      <span><strong>Pass</strong>: &lt;20% AI</span>
    </div>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <span style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%;"></span>
      <span><strong>Warning</strong>: 20-40% AI</span>
    </div>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <span style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%;"></span>
      <span><strong>Fail</strong>: &gt;40% AI</span>
    </div>
  </div>

  <!-- Results Table -->
  <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
      <thead>
        <tr style="background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
          <th style="text-align: left; padding: 0.75rem 1rem; font-weight: 500;">Page</th>
          <th style="text-align: center; padding: 0.75rem 1rem; font-weight: 500; width: 100px;">AI %</th>
          <th style="text-align: center; padding: 0.75rem 1rem; font-weight: 500; width: 100px;">Human %</th>
          <th style="text-align: center; padding: 0.75rem 1rem; font-weight: 500; width: 100px;">Status</th>
          <th style="text-align: center; padding: 0.75rem 1rem; font-weight: 500; width: 80px;">Words</th>
          <th style="text-align: center; padding: 0.75rem 1rem; font-weight: 500; width: 100px;">Action</th>
        </tr>
      </thead>
      <tbody id="results-body">
        {pagesToCheck.map(page => (
          <tr data-path={page.path} style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 0.75rem 1rem;">
              <div style="font-weight: 500;">{page.label}</div>
              <div style="font-size: 0.75rem; color: #6b7280;">{page.path}</div>
            </td>
            <td style="text-align: center; padding: 0.75rem 1rem;" class="ai-score">-</td>
            <td style="text-align: center; padding: 0.75rem 1rem;" class="human-score">-</td>
            <td style="text-align: center; padding: 0.75rem 1rem;" class="status">
              <span style="padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; background: #f3f4f6; color: #6b7280;">pending</span>
            </td>
            <td style="text-align: center; padding: 0.75rem 1rem;" class="words">-</td>
            <td style="text-align: center; padding: 0.75rem 1rem;">
              <button class="scan-btn" data-path={page.path} style="background: #e5e7eb; color: #374151; padding: 0.25rem 0.75rem; border-radius: 4px; border: none; cursor: pointer; font-size: 0.75rem;">
                Scan
              </button>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>

  <!-- Error display -->
  <div id="error-display" style="display: none; margin-top: 1rem; padding: 1rem; background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; color: #991b1b;"></div>

  <!-- Copy Section -->
  <div style="margin-top: 2rem;">
    <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Current Land Management Copy</h2>
    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
      <h3 style="font-weight: 600; margin-bottom: 0.5rem;">Hero</h3>
      <p style="background: #f9fafb; padding: 0.75rem; border-radius: 4px; font-size: 0.875rem; margin-bottom: 1rem;">
        <strong>Goats. Doing What Goats Do.</strong><br>
        We bring goats to your property. They eat the stuff you don't want. You save money. Pretty straightforward, honestly.
      </p>

      <h3 style="font-weight: 600; margin-bottom: 0.5rem;">Main Section</h3>
      <div style="background: #f9fafb; padding: 0.75rem; border-radius: 4px; font-size: 0.875rem; margin-bottom: 1rem;">
        <p style="margin-bottom: 0.5rem;"><strong>Look, Here's the Thing</strong></p>
        <p style="margin-bottom: 0.5rem;">Mowing gets expensive. Fast. Especially if you've got a big property out near Watkinsville or down by Winterville. Then there's the chemicals. The fuel costs. The guy who didn't show up last Tuesday.</p>
        <p style="margin-bottom: 0.5rem;">Here's the thing though. Goats have been doing this job forever. Way before John Deere came along. They actually like eating kudzu and privet and all that stuff you're fighting. It's not work to them. It's lunch.</p>
        <p>So yeah. We bring goats. They eat. Bo checks on them. We move them around. Your property looks better. That's basically it.</p>
      </div>

      <h3 style="font-weight: 600; margin-bottom: 0.5rem;">Property Types</h3>
      <ul style="background: #f9fafb; padding: 0.75rem 0.75rem 0.75rem 1.5rem; border-radius: 4px; font-size: 0.875rem; margin-bottom: 1rem;">
        <li><strong>Retention Ponds:</strong> You know that jungle growing around your pond? Goats think that's a buffet. No equipment to haul. No chemicals near the water. Done.</li>
        <li><strong>Solar Farms:</strong> Had a guy out near Lexington tell me his mower cracked two panels last summer. Goats? They just eat and walk away. No damage.</li>
        <li><strong>HOA Common Areas:</strong> Board members love it. Residents love it. No 7am mowing. No chemical smell drifting over the pool. Plus kids think goats are hilarious.</li>
        <li><strong>Commercial Properties:</strong> Office parks, industrial sites, that kind of thing. Big areas where mowing costs add up real quick. We can usually beat those numbers.</li>
      </ul>

      <h3 style="font-weight: 600; margin-bottom: 0.5rem;">Benefits</h3>
      <ul style="background: #f9fafb; padding: 0.75rem 0.75rem 0.75rem 1.5rem; border-radius: 4px; font-size: 0.875rem;">
        <li><strong>Saves Money:</strong> We've seen 30, sometimes 40 percent savings compared to mowing contracts. Depends on your property, but the math usually works out.</li>
        <li><strong>Zero Chemicals:</strong> Goats eat weeds. That's the whole herbicide program right there. Nothing to spray, nothing running off into the creek.</li>
        <li><strong>Actually Quiet:</strong> Had one property manager tell me she could finally hear herself think on Wednesdays. That was her mowing day before.</li>
        <li><strong>Built-In Fertilizer:</strong> Goes in, comes out. Basic biology. Your soil ends up better than when we started. Can't say that about a mower.</li>
        <li><strong>Good for the Land:</strong> Rotational grazing is how grasslands evolved. The land actually recovers. Gets healthier. Bit of science there, but it works.</li>
        <li><strong>Not Your Problem:</strong> Bo handles the goats. We handle the logistics. You get results without having to learn animal husbandry.</li>
      </ul>
    </div>
  </div>
</AdminLayout>

<script>
  const statusColors = {
    pass: { bg: '#dcfce7', color: '#166534' },
    warning: { bg: '#fef3c7', color: '#92400e' },
    fail: { bg: '#fee2e2', color: '#991b1b' },
    scanning: { bg: '#dbeafe', color: '#1e40af' },
    error: { bg: '#fee2e2', color: '#991b1b' },
  };

  function updateRow(path: string, data: {
    aiScore?: number | string;
    humanScore?: number | string;
    status?: string;
    words?: number | string;
  }) {
    const row = document.querySelector(`tr[data-path="${path}"]`);
    if (!row) return;

    if (data.aiScore !== undefined) {
      const aiCell = row.querySelector('.ai-score');
      if (aiCell) aiCell.textContent = String(data.aiScore);
    }

    if (data.humanScore !== undefined) {
      const humanCell = row.querySelector('.human-score');
      if (humanCell) humanCell.textContent = String(data.humanScore);
    }

    if (data.words !== undefined) {
      const wordsCell = row.querySelector('.words');
      if (wordsCell) wordsCell.textContent = String(data.words);
    }

    if (data.status) {
      const statusCell = row.querySelector('.status');
      if (statusCell) {
        const colors = statusColors[data.status as keyof typeof statusColors] || statusColors.error;
        statusCell.innerHTML = `<span style="padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; background: ${colors.bg}; color: ${colors.color};">${data.status}</span>`;
      }
    }
  }

  function setButtonState(path: string, disabled: boolean, text?: string) {
    const btn = document.querySelector(`button[data-path="${path}"]`) as HTMLButtonElement;
    if (btn) {
      btn.disabled = disabled;
      if (text) btn.textContent = text;
      btn.style.opacity = disabled ? '0.5' : '1';
    }
  }

  async function scanPage(path: string) {
    const envSelect = document.getElementById('env-select') as HTMLSelectElement;
    const baseUrl = envSelect?.value || 'https://sme-frontend-delta.vercel.app';
    const fullUrl = baseUrl + path;

    setButtonState(path, true, 'Scanning...');
    updateRow(path, { status: 'scanning', aiScore: '...', humanScore: '...', words: '...' });

    try {
      const response = await fetch('/api/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: fullUrl })
      });

      const result = await response.json();

      if (!response.ok || result.error) {
        throw new Error(result.error || 'Scan failed');
      }

      updateRow(path, {
        aiScore: result.aiScore + '%',
        humanScore: result.humanScore + '%',
        status: result.status,
        words: result.wordCount
      });

    } catch (error) {
      const message = error instanceof Error ? error.message : 'Unknown error';
      updateRow(path, { status: 'error', aiScore: '-', humanScore: '-', words: '-' });

      const errorDisplay = document.getElementById('error-display');
      if (errorDisplay) {
        errorDisplay.style.display = 'block';
        errorDisplay.textContent = `Error scanning ${path}: ${message}`;
      }
    } finally {
      setButtonState(path, false, 'Scan');
    }
  }

  // Individual scan buttons
  document.querySelectorAll('.scan-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const path = (btn as HTMLButtonElement).dataset.path;
      if (path) scanPage(path);
    });
  });

  // Scan all button
  document.getElementById('scan-all-btn')?.addEventListener('click', async () => {
    const scanAllBtn = document.getElementById('scan-all-btn') as HTMLButtonElement;
    const statusSpan = document.getElementById('scan-status');
    const paths = Array.from(document.querySelectorAll('tr[data-path]')).map(row => row.getAttribute('data-path')!);

    scanAllBtn.disabled = true;
    scanAllBtn.style.opacity = '0.5';

    for (let i = 0; i < paths.length; i++) {
      if (statusSpan) statusSpan.textContent = `Scanning ${i + 1} of ${paths.length}...`;
      await scanPage(paths[i]);
      // Small delay between requests
      await new Promise(resolve => setTimeout(resolve, 500));
    }

    if (statusSpan) statusSpan.textContent = 'Complete!';
    scanAllBtn.disabled = false;
    scanAllBtn.style.opacity = '1';
  });
</script>
